<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chicago Building Permit Contractor Search</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0b0c0c;
            --surface-color: #1d1f20;
            --border-color: #383b3d;
            --text-primary: #ffffff;
            --text-secondary: #b1b4b6;
            --accent-color: #1d70b8;
            --accent-hover: #003078;
            --error-color: #d4351c;
            --success-color: #00703c;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-main);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Header & Typography */
        header {
            margin-bottom: 3rem;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 1rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-size: 1.1rem;
        }

        /* Search Section */
        .search-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--surface-color);
            padding: 1.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        label {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
        }

        input[type="text"] {
            flex: 1;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            background: #000;
            border: 2px solid var(--text-primary);
            color: white;
            border-radius: 0;
            outline: none;
        }

        input[type="text"]:focus {
            box-shadow: 0 0 0 3px #ffdd00;
            border-color: #000;
            color: #fff;
        }

        button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 2px 0 var(--accent-hover);
        }

        button:hover {
            background-color: var(--accent-hover);
        }

        button:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            min-height: 40px;
        }

        .stats {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .export-btn {
            background-color: var(--success-color);
            box-shadow: 0 2px 0 #004d2c;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            display: none; /* Hidden until results exist */
        }

        /* Results Display */
        .results-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .permit-card {
            background: var(--surface-color);
            border-left: 5px solid var(--accent-color);
            padding: 1.5rem;
            border-radius: 0 4px 4px 0;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .permit-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }

        .permit-id {
            font-weight: 700;
            color: var(--accent-color);
            font-family: monospace;
            font-size: 1.1rem;
        }

        .permit-date {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .address-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .permit-address {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .map-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-color);
            text-decoration: none;
            padding: 4px;
            border-radius: 4px;
            background: rgba(29, 112, 184, 0.1);
            transition: all 0.2s ease;
        }

        .map-link:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }

        .map-link svg {
            width: 20px;
            height: 20px;
        }

        .permit-description {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            font-size: 1rem;
            background: rgba(255,255,255,0.03);
            padding: 0.75rem;
            border-radius: 4px;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .meta-item label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .meta-item span {
            font-weight: 500;
        }

        .contact-box {
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }

        .contact-tag {
            display: inline-block;
            background: rgba(29, 112, 184, 0.15);
            border: 1px solid var(--accent-color);
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .contact-tag.highlight {
            background: var(--accent-color);
            color: white;
        }

        /* Loading Spinner */
        .loader {
            text-align: center;
            padding: 3rem;
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .input-group {
                flex-direction: column;
            }
            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Chicago Building Permit Explorer</h1>
        <p class="subtitle">Search 15+ years of city development records by contractor or entity name.</p>
    </header>

    <main>
        <div class="search-controls">
            <label for="searchQuery">Search for a person or company</label>
            <div class="input-group">
                <input type="text" id="searchQuery" placeholder="e.g. Toro Construction" aria-label="Contractor Name">
                <button id="searchBtn">Search Records</button>
            </div>
        </div>

        <div class="toolbar">
            <div id="resultStats" class="stats"></div>
            <button id="exportBtn" class="export-btn">Download CSV Data</button>
        </div>

        <div id="loader" class="loader">
            <div class="spinner"></div>
            <p>Querying City of Chicago Data Portal...</p>
        </div>

        <div id="results" class="results-list">
            <!-- Results will be injected here -->
        </div>
    </main>
</div>

<script>
    const searchBtn = document.getElementById('searchBtn');
    const exportBtn = document.getElementById('exportBtn');
    const searchQuery = document.getElementById('searchQuery');
    const resultsContainer = document.getElementById('results');
    const loader = document.getElementById('loader');
    const resultStats = document.getElementById('resultStats');

    let currentResults = [];
    let lastSearchTerm = "";

    searchBtn.addEventListener('click', performSearch);
    searchQuery.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch();
    });

    async function performSearch() {
        const query = searchQuery.value.trim().toUpperCase();
        if (!query) return;

        lastSearchTerm = query;
        showLoading(true);
        resultsContainer.innerHTML = '';
        exportBtn.style.display = 'none';
        resultStats.textContent = '';

        try {
            // Build SoQL query
            const contactFields = Array.from({length: 15}, (_, i) => `upper(contact_${i+1}_name) like '%${query}%'`);
            const whereClause = contactFields.join(' OR ');
            
            // Encode for URL
            const url = `https://data.cityofchicago.org/resource/ydr8-5enu.json?$where=${encodeURIComponent(whereClause)}&$limit=2000`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error('API request failed');
            
            const data = await response.json();
            currentResults = data;
            
            displayResults(data, query);
        } catch (error) {
            console.error(error);
            resultsContainer.innerHTML = `<p style="color:var(--error-color)">Error connecting to Chicago Data Portal. Please try again later.</p>`;
        } finally {
            showLoading(false);
        }
    }

    function showLoading(isLoading) {
        loader.style.display = isLoading ? 'block' : 'none';
        searchBtn.disabled = isLoading;
    }

    function displayResults(data, term) {
        if (data.length === 0) {
            resultStats.textContent = `No matches found for "${term}"`;
            return;
        }

        resultStats.textContent = `Found ${data.length} records matching "${term}"`;
        exportBtn.style.display = 'block';

        data.forEach(permit => {
            const card = document.createElement('div');
            card.className = 'permit-card';

            // Extract matching contacts
            let matches = [];
            let others = [];
            for(let i=1; i<=15; i++) {
                const name = permit[`contact_${i}_name`];
                const type = permit[`contact_${i}_type`];
                if (name) {
                    const info = { name, type };
                    if (name.toUpperCase().includes(term)) {
                        matches.push(info);
                    } else {
                        others.push(info);
                    }
                }
            }

            const issueDate = permit.issue_date ? permit.issue_date.split('T')[0] : 'Unknown Date';
            const cost = permit.reported_cost ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(permit.reported_cost) : '$0.00';
            const address = `${permit.street_number || ''} ${permit.street_direction || ''} ${permit.street_name || ''}`.trim() || 'No Address Listed';
            
            // Generate Google Maps Link with "Chicago, IL" included
            const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address + ', CHICAGO, IL')}`;

            card.innerHTML = `
                <div class="permit-header">
                    <span class="permit-id">Permit #${permit.permit_ || 'N/A'}</span>
                    <span class="permit-date">Issued: ${issueDate}</span>
                </div>
                <div class="address-wrapper">
                    <div class="permit-address">${address}</div>
                    <a href="${googleMapsUrl}" target="_blank" class="map-link" title="View on Google Maps">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                    </a>
                </div>
                <div class="permit-description">${permit.work_description || 'No work description provided.'}</div>
                
                <div class="metadata-grid">
                    <div class="meta-item">
                        <label>Status</label>
                        <span>${permit.permit_status || 'N/A'}</span>
                    </div>
                    <div class="meta-item">
                        <label>Reported Cost</label>
                        <span>${cost}</span>
                    </div>
                    <div class="meta-item">
                        <label>Review Type</label>
                        <span>${permit.review_type || 'N/A'}</span>
                    </div>
                </div>

                <div class="contact-box">
                    <label style="font-size:0.75rem; color:var(--text-secondary); text-transform:uppercase; display:block; margin-bottom:0.5rem;">Relevant Contacts</label>
                    ${matches.map(m => `<span class="contact-tag highlight"><strong>${m.type}:</strong> ${m.name}</span>`).join('')}
                    ${others.map(o => `<span class="contact-tag"><strong>${o.type}:</strong> ${o.name}</span>`).join('')}
                </div>
            `;
            resultsContainer.appendChild(card);
        });
    }

    // CSV Generation Logic
    exportBtn.addEventListener('click', () => {
        if (currentResults.length === 0) return;

        // Get all unique keys for headers
        const headers = Array.from(new Set(currentResults.flatMap(Object.keys)));
        
        const csvContent = [
            headers.join(','),
            ...currentResults.map(row => headers.map(header => {
                let cell = row[header] === undefined || row[header] === null ? '' : String(row[header]);
                // Escape quotes and wrap in quotes for CSV safety
                cell = cell.replace(/"/g, '""');
                return `"${cell}"`;
            }).join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `chicago_permits_${lastSearchTerm.toLowerCase()}_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
</script>

</body>
</html>
